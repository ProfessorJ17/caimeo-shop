<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        const express = require('express');
const axios = require('axios');
const cors = require('cors');
const multer = require('multer');
const dotenv = require('dotenv');

dotenv.config();

const app = express();
const upload = multer({ storage: multer.memoryStorage() });

// Allow CORS for your frontend origins
app.use(cors({
    origin: ['https://caimeo.shop', 'https://caimeo.moddarkrevolt.repl.co', 'http://localhost:3000'],
    methods: ['GET', 'POST'],
    allowedHeaders: ['Content-Type']
}));
app.use(express.json());

// OpenAI API configuration
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
if (!OPENAI_API_KEY) {
    console.error('Error: OPENAI_API_KEY is not set in .env');
    process.exit(1);
}

const openaiHeaders = {
    'Authorization': `Bearer ${OPENAI_API_KEY}`,
    'Content-Type': 'application/json'
};

// Chat endpoint (OpenAI chat completion)
app.post('/api/chat', async (req, res) => {
    const { model, messages, max_tokens, temperature, top_p } = req.body;

    if (!model || !messages) {
        return res.status(400).json({ error: { message: 'Model and messages are required' } });
    }

    try {
        const response = await axios.post(
            'https://api.openai.com/v1/chat/completions',
            { model, messages, max_tokens, temperature, top_p },
            { headers: openaiHeaders }
        );
        res.json(response.data);
    } catch (error) {
        console.error('Chat API error:', error.response?.data || error.message);
        res.status(error.response?.status || 500).json({
            error: { message: error.response?.data?.error?.message || error.message }
        });
    }
});

// Image generation endpoint (OpenAI DALL·E)
app.post('/api/image', async (req, res) => {
    const { model, prompt, n, size, quality, response_format } = req.body;

    if (!model || !prompt) {
        return res.status(400).json({ error: { message: 'Model and prompt are required' } });
    }

    try {
        const response = await axios.post(
            'https://api.openai.com/v1/images/generations',
            { model, prompt, n, size, quality, response_format },
            { headers: openaiHeaders }
        );
        res.json(response.data);
    } catch (error) {
        console.error('Image API error:', error.response?.data || error.message);
        res.status(error.response?.status || 500).json({
            error: { message: error.response?.data?.error?.message || error.message }
        });
    }
});

// Text-to-speech endpoint (OpenAI TTS)
app.post('/api/tts', async (req, res) => {
    const { model, input, voice, response_format } = req.body;

    if (!model || !input) {
        return res.status(400).json({ error: { message: 'Model and input are required' } });
    }

    try {
        const response = await axios.post(
            'https://api.openai.com/v1/audio/speech',
            { model, input, voice, response_format },
            { headers: openaiHeaders, responseType: 'arraybuffer' }
        );
        res.set('Content-Type', 'audio/mpeg');
        res.send(response.data);
    } catch (error) {
        console.error('TTS API error:', error.response?.data || error.message);
        res.status(error.response?.status || 500).json({
            error: { message: error.response?.data?.error?.message || error.message }
        });
    }
});

// Transcription endpoint (OpenAI Whisper)
app.post('/api/transcribe', upload.single('file'), async (req, res) => {
    const { model } = req.body;
    const file = req.file;

    if (!model || !file) {
        return res.status(400).json({ error: { message: 'Model and file are required' } });
    }

    try {
        const formData = new FormData();
        formData.append('file', file.buffer, { filename: 'audio.webm' });
        formData.append('model', model);

        const response = await axios.post(
            'https://api.openai.com/v1/audio/transcriptions',
            formData,
            { headers: { ...openaiHeaders, 'Content-Type': 'multipart/form-data' } }
        );
        res.json(response.data);
    } catch (error) {
        console.error('Transcribe API error:', error.response?.data || error.message);
        res.status(error.response?.status || 500).json({
            error: { message: error.response?.data?.error?.message || error.message }
        });
    }
});

const PORT = process.env.PORT || 5000;
const server = app.listen(PORT, '0.0.0.0', () => {
    console.log(`Server running on port ${PORT}`);
});

// Handle both HTTP and HTTPS
server.on('upgrade', (request, socket, head) => {
    console.log('Upgrade request received');
});
        </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAIMEO Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        #chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .message {
            margin: 10px 0;
        }
        .user {
            text-align: right;
            color: #007bff;
        }
        .bot {
            text-align: left;
            color: #333;
        }
        .error {
            color: red;
        }
        #input-container {
            display: flex;
            gap: 10px;
        }
        #user-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #controls {
            margin-top: 10px;
        }
        select, input[type="range"], input[type="checkbox"] {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-box"></div>
        <div id="input-container">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
            <button onclick="startRecording()">🎤 Record</button>
        </div>
        <div id="controls">
            <label>Text Model:
                <select id="text-model-select">
                    <option value="gpt-4o">GPT-4o</option>
                </select>
            </label>
            <label>Image Model:
                <select id="image-model-select">
                    <option value="dall-e-3">DALL·E 3</option>
                </select>
            </label>
            <label>Max Tokens: <input type="range" id="max-tokens-slider" min="50" max="4096" value="1000"></label>
            <label>Temperature: <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="0.7"></label>
            <label>Top P: <input type="range" id="top-p-slider" min="0" max="1" step="0.1" value="0.9"></label>
            <label>Enable Image: <input type="checkbox" id="enable-image-model"></label>
            <label>Enable TTS: <input type="checkbox" id="enable-tts-model"></label>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const textModelSelect = document.getElementById('text-model-select');
        const imageModelSelect = document.getElementById('image-model-select');
        const maxTokensSlider = document.getElementById('max-tokens-slider');
        const temperatureSlider = document.getElementById('temperature-slider');
        const topPSlider = document.getElementById('top-p-slider');
        const enableImageModelCheckbox = document.getElementById('enable-image-model');
        const enableTtsModelCheckbox = document.getElementById('enable-tts-model');
        let history = [];
        let mediaRecorder;
        let audioChunks = [];

        async function callChatAPI(messages, model) {
            const maxTokens = parseInt(maxTokensSlider.value, 10);
            const temp = parseFloat(temperatureSlider.value);
            const topP = parseFloat(topPSlider.value);

            console.log(`Calling Chat API with model: ${model}, max_tokens: ${maxTokens}, temp: ${temp}, top_p: ${topP}`);

            try {
                const response = await fetch('https://5000-' + window.location.hostname + '/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model,
                        messages,
                        max_tokens: maxTokens,
                        temperature: temp,
                        top_p: topP
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Chat API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return {
                    content: data.choices[0].message.content,
                    sources: data.choices[0].context?.citations?.map(c => c.url || c.uri) || []
                };
            } catch (error) {
                console.error('Chat API error:', error);
                throw error;
            }
        }

        async function callImageAPI(prompt, model) {
            console.log(`Calling Image API with model: ${model}, prompt: ${prompt.substring(0, 50)}...`);

            try {
                const response = await fetch('https://caimeo.moddarkrevolt.repl.co/api/image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model,
                        prompt,
                        n: 1,
                        size: '1024x1024',
                        quality: 'standard',
                        response_format: 'url'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Image API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.data[0].url;
            } catch (error) {
                console.error('Image API error:', error);
                throw error;
            }
        }

        async function callTTSAPI(text, model = 'tts-1', voice = 'alloy') {
            console.log(`Calling TTS API with model: ${model}, voice: ${voice}`);

            try {
                const response = await fetch('https://caimeo.moddarkrevolt.repl.co/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model,
                        input: text,
                        voice,
                        response_format: 'mp3'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`TTS API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                return await response.blob();
            } catch (error) {
                console.error('TTS API error:', error);
                throw error;
            }
        }

        async function callTranscribeAPI(audioBlob) {
            console.log('Calling Transcribe API...');

            const formData = new FormData();
            formData.append('file', audioBlob, 'audio.webm');
            formData.append('model', 'whisper-1');

            try {
                const response = await fetch('https://caimeo.moddarkrevolt.repl.co/api/transcribe', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Transcribe API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.text;
            } catch (error) {
                console.error('Transcribe API error:', error);
                throw error;
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            appendMessage('user', message);
            userInput.value = '';
            history.push({ role: 'user', content: message });

            const thinkingMsg = document.createElement('div');
            thinkingMsg.className = 'message bot';
            thinkingMsg.textContent = 'Thinking...';
            chatBox.appendChild(thinkingMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const selectedModel = textModelSelect.value;
                const systemPrompt = 'You are CAIMEO, an AI assistant. Provide helpful and accurate responses.';
                const messages = [{ role: 'system', content: systemPrompt }, ...history.slice(-10)];

                const response = await callChatAPI(messages, selectedModel);
                const responseContent = response.content;
                const sources = response.sources;

                chatBox.removeChild(thinkingMsg);
                appendMessage('bot', responseContent, sources);
                history.push({ role: 'assistant', content: responseContent });

                if (enableImageModelCheckbox.checked) {
                    const imgLoading = document.createElement('div');
                    imgLoading.className = 'message bot';
                    imgLoading.textContent = 'Generating image...';
                    chatBox.appendChild(imgLoading);
                    chatBox.scrollTop = chatBox.scrollHeight;

                    try {
                        const imagePrompt = message.split('.')[0];
                        const imageModel = imageModelSelect.value;
                        const imageUrl = await callImageAPI(imagePrompt, imageModel);
                        imgLoading.remove();
                        appendMessage('bot', `<img src="${imageUrl}" alt="Generated Image" style="max-width: 100%; height: auto; border-radius: 4px;">`);
                    } catch (error) {
                        imgLoading.remove();
                        appendMessage('bot', `Image generation failed: ${error.message}`, [], true);
                    }
                }

                if (enableTtsModelCheckbox.checked) {
                    try {
                        const audioBlob = await callTTSAPI(responseContent);
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                    } catch (error) {
                        appendMessage('bot', `TTS failed: ${error.message}`, [], true);
                    }
                }
            } catch (error) {
                chatBox.removeChild(thinkingMsg);
                appendMessage('bot', `Error: ${error.message}`, [], true);
            }
        }

        async function startRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        try {
                            const transcribedText = await callTranscribeAPI(audioBlob);
                            userInput.value = transcribedText;
                            sendMessage();
                        } catch (error) {
                            appendMessage('bot', `Transcription failed: ${error.message}`, [], true);
                        }
                    };

                    mediaRecorder.start();
                    document.querySelector('#input-container button:last-child').textContent = '⏹ Stop';
                } catch (error) {
                    appendMessage('bot', `Recording failed: ${error.message}`, [], true);
                }
            } else {
                mediaRecorder.stop();
                document.querySelector('#input-container button:last-child').textContent = '🎤 Record';
            }
        }

        function appendMessage(role, content, sources = [], isError = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role} ${isError ? 'error' : ''}`;
            msgDiv.innerHTML = content;
            if (sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.style.fontSize = '0.8em';
                sourcesDiv.innerHTML = 'Sources: ' + sources.map(s => `<a href="${s}" target="_blank">${s}</a>`).join(', ');
                msgDiv.appendChild(sourcesDiv);
            }
            if (role === 'bot' && !isError) {
                const speakButton = document.createElement('button');
                speakButton.textContent = '🔊 Speak';
                speakButton.onclick = async () => {
                    try {
                        const audioBlob = await callTTSAPI(content);
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                    } catch (error) {
                        appendMessage('bot', `TTS failed: ${error.message}`, [], true);
                    }
                };
                msgDiv.appendChild(speakButton);
            }
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
