<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAIMEO Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        #chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .message {
            margin: 10px 0;
        }
        .user {
            text-align: right;
            color: #007bff;
        }
        .bot {
            text-align: left;
            color: #333;
        }
        .error {
            color: red;
        }
        #input-container {
            display: flex;
            gap: 10px;
        }
        #user-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #controls {
            margin-top: 10px;
        }
        select, input[type="range"], input[type="checkbox"] {
            margin: 0 5px;
        }
        #api-error {
            color: red;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-box"></div>
        <div id="input-container">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
            <button onclick="startRecording()">üéôÔ∏è Record</button>
        </div>
        <div id="api-error"></div>
        <div id="controls">
            <label>Text Model:
                <select id="text-model-select">
                    <option value="gpt-4o">GPT-4o</option>
                </select>
            </label>
            <label>Image Model:
                <select id="image-model-select">
                    <option value="dall-e-3">DALL¬∑E 3</option>
                </select>
            </label>
            <label>Max Tokens: <input type="range" id="max-tokens-slider" min="50" max="4096" value="1000"></label>
            <label>Temperature: <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="0.7"></label>
            <label>Top P: <input type="range" id="top-p-slider" min="0" max="1" step="0.1" value="0.9"></label>
            <label>Enable Image: <input type="checkbox" id="enable-image-model"></label>
            <label>Enable TTS: <input type="checkbox" id="enable-tts-model"></label>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const apiErrorDiv = document.getElementById('api-error');
        const textModelSelect = document.getElementById('text-model-select');
        const imageModelSelect = document.getElementById('image-model-select');
        const maxTokensSlider = document.getElementById('max-tokens-slider');
        const temperatureSlider = document.getElementById('temperature-slider');
        const topPSlider = document.getElementById('top-p-slider');
        const enableImageModelCheckbox = document.getElementById('enable-image-model');
        const enableTtsModelCheckbox = document.getElementById('enable-tts-model');
        let history = [];
        let mediaRecorder;
        let audioChunks = [];
        const API_BASE_URL = 'https://caimeo.moddarkrevolt.repl.co'; // Primary Replit backend URL
        const FALLBACK_API_URL = 'https://caimeo.moddarkrevolt.repl.co'; // Update with new Replit URL if changed
        const MAX_RETRIES = 3;
        const RETRY_DELAY_MS = 1000;

        console.log('Frontend loaded with API_BASE_URL:', API_BASE_URL);
        console.log('Fallback API URL:', FALLBACK_API_URL);
        console.log('Frontend origin:', window.location.origin);
        console.log('Testing API connectivity at:', `${API_BASE_URL}/api/health`);

        async function withRetry(fn, maxRetries = MAX_RETRIES) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    console.log(`Attempt ${attempt} failed: ${error.message}. Retrying in ${RETRY_DELAY_MS}ms...`);
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                }
            }
        }

        async function callChatAPI(messages, model) {
            const maxTokens = parseInt(maxTokensSlider.value, 10);
            const temp = parseFloat(temperatureSlider.value);
            const topP = parseFloat(topPSlider.value);

            console.log(`Calling Chat API with model: ${model}, max_tokens: ${maxTokens}, temp: ${temp}, top_p: ${topP}, URL: ${API_BASE_URL}/api/chat`);

            return await withRetry(async () => {
                let response;
                try {
                    response = await fetch(`${API_BASE_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model,
                            messages,
                            max_tokens: maxTokens,
                            temperature: temp,
                            top_p: topP
                        })
                    });
                } catch (error) {
                    console.log(`Primary URL failed: ${error.message}. Trying fallback URL: ${FALLBACK_API_URL}`);
                    response = await fetch(`${FALLBACK_API_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model,
                            messages,
                            max_tokens: maxTokens,
                            temperature: temp,
                            top_p: topP
                        })
                    });
                }

                console.log('Chat API response status:', response.status, 'URL:', response.url);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Chat API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (!data.choices?.[0]?.message?.content) {
                    throw new Error('Invalid API response structure');
                }
                return {
                    content: data.choices[0].message.content,
                    sources: data.choices[0].context?.citations?.map(c => c.url || c.uri) || []
                };
            });
        }

        async function callImageAPI(prompt, model) {
            console.log(`Calling Image API with model: ${model}, prompt: ${prompt.substring(0, 50)}..., URL: ${API_BASE_URL}/api/image`);

            return await withRetry(async () => {
                const response = await fetch(`${API_BASE_URL}/api/image`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model,
                        prompt,
                        n: 1,
                        size: '1024x1024',
                        quality: 'standard',
                        response_format: 'url'
                    })
                });

                console.log('Image API response status:', response.status, 'URL:', response.url);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Image API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (!data.data?.[0]?.url) {
                    throw new Error('Invalid Image API response');
                }
                return data.data[0].url;
            });
        }

        async function callTTSAPI(text, model = 'tts-1', voice = 'alloy') {
            console.log(`Calling TTS API with model: ${model}, voice: ${voice}, URL: ${API_BASE_URL}/api/tts`);

            return await withRetry(async () => {
                const response = await fetch(`${API_BASE_URL}/api/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model,
                        input: text,
                        voice,
                        response_format: 'mp3'
                    })
                });

                console.log('TTS API response status:', response.status, 'URL:', response.url);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`TTS API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                return await response.blob();
            });
        }

        async function callTranscribeAPI(audioBlob) {
            console.log(`Calling Transcribe API, URL: ${API_BASE_URL}/api/transcribe`);

            return await withRetry(async () => {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-1');

                const response = await fetch(`${API_BASE_URL}/api/transcribe`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Transcribe API response status:', response.status, 'URL:', response.url);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Transcribe API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (!data.text) {
                    throw new Error('Invalid Transcribe API response');
                }
                return data.text;
            });
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            appendMessage('user', message);
            userInput.value = '';
            history.push({ role: 'user', content: message });
            if (history.length > 20) history = history.slice(-20);

            const thinkingMsg = document.createElement('div');
            thinkingMsg.className = 'message bot';
            thinkingMsg.textContent = 'Thinking...';
            chatBox.appendChild(thinkingMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const selectedModel = textModelSelect.value;
                const systemPrompt = 'You are CAIMEO, an AI assistant. Provide helpful and accurate responses.';
                const messages = [{ role: 'system', content: systemPrompt }, ...history.slice(-10)];

                const response = await callChatAPI(messages, selectedModel);
                const responseContent = response.content;
                const sources = response.sources;

                chatBox.removeChild(thinkingMsg);
                appendMessage('bot', responseContent, sources);
                history.push({ role: 'assistant', content: responseContent });

                if (enableImageModelCheckbox.checked) {
                    const imgLoading = document.createElement('div');
                    imgLoading.className = 'message bot';
                    imgLoading.textContent = 'Generating image...';
                    chatBox.appendChild(imgLoading);
                    chatBox.scrollTop = chatBox.scrollHeight;

                    try {
                        const imagePrompt = message.split('.')[0];
                        const imageModel = imageModelSelect.value;
                        const imageUrl = await callImageAPI(imagePrompt, imageModel);
                        imgLoading.remove();
                        appendMessage('bot', `<img src="${imageUrl}" alt="Generated Image" style="max-width: 100%; height: auto; border-radius: 4px;">`);
                    } catch (error) {
                        imgLoading.remove();
                        appendMessage('bot', `Image generation failed: ${error.message}`, [], true);
                    }
                }

                if (enableTtsModelCheckbox.checked) {
                    try {
                        const audioBlob = await callTTSAPI(responseContent);
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                    } catch (error) {
                        appendMessage('bot', `TTS failed: ${error.message}`, [], true);
                    }
                }
            } catch (error) {
                chatBox.removeChild(thinkingMsg);
                appendMessage('bot', `Error: ${error.message}`, [], true);
            }
        }

        async function startRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        try {
                            const transcribedText = await callTranscribeAPI(audioBlob);
                            userInput.value = transcribedText;
                            sendMessage();
                        } catch (error) {
                            appendMessage('bot', `Transcription failed: ${error.message}`, [], true);
                        }
                    };

                    mediaRecorder.start();
                    document.querySelector('#input-container button:last-child').textContent = '‚èπ Stop';
                } catch (error) {
                    appendMessage('bot', `Recording failed: ${error.message}`, [], true);
                }
            } else {
                mediaRecorder.stop();
                document.querySelector('#input-container button:last-child').textContent = 'üéôÔ∏è Record';
            }
        }

        function appendMessage(role, content, sources = [], isError = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role} ${isError ? 'error' : ''}`;
            msgDiv.innerHTML = content;
            if (sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.style.fontSize = '0.8em';
                sourcesDiv.innerHTML = 'Sources: ' + sources.map(s => `<a href="${s}" target="_blank">${s}</a>`).join(', ');
                msgDiv.appendChild(sourcesDiv);
            }
            if (role === 'bot' && !isError) {
                const speakButton = document.createElement('button');
                speakButton.textContent = 'üîä Speak';
                speakButton.onclick = async () => {
                    try {
                        const audioBlob = await callTTSAPI(content);
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                    } catch (error) {
                        appendMessage('bot', `TTS failed: ${error.message}`, [], true);
                    }
                };
                msgDiv.appendChild(speakButton);
            }
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Test API connectivity on load
        async function testAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                console.log('API health check:', response.status, await response.json());
                apiErrorDiv.textContent = '';
            } catch (error) {
                console.log('API health check failed:', error.message);
                apiErrorDiv.textContent = `‚ö†Ô∏è Backend not reachable at ${API_BASE_URL}. Check Replit server status and update API_BASE_URL if the Webview URL has changed.`;
                appendMessage('bot', `API connectivity test failed: ${error.message}`, [], true);
            }
        }
        testAPI();
    </script>
</body>
</html>
