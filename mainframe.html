<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MAINFRAME LOGIN</title>
  <style>
    body { font-family: Arial; background: #f0f0f0; display: flex; justify-content: center; align-items: center; height: 100vh; }
    #login-container, #content-container {
      background: white; padding: 30px; border-radius: 8px; width: 350px; box-shadow: 0 0 10px #aaa; text-align: center;
    }
    input, button {
      width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; border-radius: 5px; border: 1px solid #ccc;
    }
    button { background: black; color: white; border: none; cursor: pointer; }
    button:hover { opacity: 0.85; }
    #error-msg { color: red; min-height: 20px; white-space: pre-wrap; }

    #custom-content {
      display: none;
      background: white; 
      padding: 30px; 
      border-radius: 8px; 
      width: 350px; 
      box-shadow: 0 0 10px #aaa; 
      margin-top: 20px;
      text-align: center;
    }
    #custom-header {
      font-size: 24px; 
      font-weight: bold; 
      margin-bottom: 15px;
    }
    #custom-footer {
      margin-top: 30px; 
      font-size: 12px; 
      color: gray;
    }
    #close-welcome-btn {
      margin-top: 15px;
      background: #333;
      width: auto;
      padding: 8px 20px;
    }
  </style>
</head>
<body>

<div id="login-container">
  <h2>MAINFRAME</h2>
  <input type="email" id="email" placeholder="Enter your email" autocomplete="username" />
  <input type="password" id="access-password" placeholder="Enter your access password" autocomplete="current-password" />
  <button id="login-button">Login</button>
  <div id="error-msg"></div>
</div>

<div id="content-container" style="display:none;">
  <h1>Welcome!</h1>
  <p id="welcome-msg" style="white-space: pre-wrap;"></p>
  <button id="close-welcome-btn">Continue</button>
  <button id="logout-button">Logout</button>
</div>

<div id="custom-content">
  <style>
    /* Example custom styles */
  </style>
  <div id="custom-header">[Custom Header Content]</div>
  <p>[Custom Body Content]</p>
  <div id="custom-footer">[Custom Footer Content]</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDYXyAmDC_HF4scI21VeLlS4aM2k2RJ1Wc",
    authDomain: "mainframe-e3b13.firebaseapp.com",
    projectId: "mainframe-e3b13",
    storageBucket: "mainframe-e3b13.appspot.com",
    messagingSenderId: "85561924382",
    appId: "1:85561924382:web:5d5eddda04a466ec56870f"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('access-password');
  const loginBtn = document.getElementById('login-button');
  const errorMsg = document.getElementById('error-msg');
  const loginContainer = document.getElementById('login-container');
  const contentContainer = document.getElementById('content-container');
  const welcomeMsg = document.getElementById('welcome-msg');
  const logoutBtn = document.getElementById('logout-button');
  const closeWelcomeBtn = document.getElementById('close-welcome-btn');
  const customContent = document.getElementById('custom-content');

  function generateToken() {
    return Math.random().toString(36).substr(2) + Date.now().toString(36);
  }

  loginBtn.addEventListener('click', async () => {
    errorMsg.textContent = '';
    const email = emailInput.value.trim().toLowerCase();
    const accessPassword = passwordInput.value;

    if (!email || !accessPassword) {
      errorMsg.textContent = 'Please enter both email and access password.';
      return;
    }

    try {
      const querySnapshot = await db.collection('purchasedUsers').where('email', '==', email).get();

      if (querySnapshot.empty) {
        errorMsg.textContent = 'No purchase record found for this email.';
        return;
      }

      let validUser = null;

      querySnapshot.forEach(doc => {
        const data = doc.data();
        if (
          data.purchased === true &&
          data.password === accessPassword
        ) {
          const now = new Date();
          const start = new Date(data.startDay);
          const end = new Date(data.endDay);
          if (now >= start && now <= end) {
            validUser = data;
          }
        }
      });

      if (!validUser) {
        errorMsg.textContent = 'Invalid access password or purchase expired.';
        return;
      }

      const token = generateToken();
      sessionStorage.setItem('sessionToken', token);
      sessionStorage.setItem('loggedInUser', email);
      showContent(email, validUser.startDay, validUser.endDay);

    } catch (error) {
      errorMsg.textContent = 'Login error: ' + error.message;
    }
  });

  closeWelcomeBtn.addEventListener('click', () => {
    const token = sessionStorage.getItem('sessionToken');
    if (!token) {
      alert("Session expired. Please log in again.");
      location.reload();
      return;
    }
    window.location.href = "dashboard.html?token=" + token;
  });

  logoutBtn.addEventListener('click', () => {
    sessionStorage.removeItem('sessionToken');
    sessionStorage.removeItem('loggedInUser');
    loginContainer.style.display = 'block';
    contentContainer.style.display = 'none';
    customContent.style.display = 'none';
    emailInput.value = '';
    passwordInput.value = '';
    errorMsg.textContent = '';
  });

  function showContent(email, startDay, endDay) {
    loginContainer.style.display = 'none';
    contentContainer.style.display = 'block';
    welcomeMsg.textContent = `Logged in as: ${email}\nPurchase valid from ${new Date(startDay).toDateString()} to ${new Date(endDay).toDateString()}`;
  }

  // Optional: Check for session on page load
  window.addEventListener('load', () => {
    const token = sessionStorage.getItem('sessionToken');
    const user = sessionStorage.getItem('loggedInUser');
    if (token && user) {
      showContent(user, '[Session]', '[Session]');
    }
  });
</script>

</body>
</html>
